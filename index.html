<!--
      :::    :::       ::::::::::           :::        :::::::::
     :+:    :+:       :+:                :+: :+:      :+:    :+:
    +:+    +:+       +:+               +:+   +:+     +:+    +:+
   +#++:++#++       +#++:++#         +#++:++#++:    +#+    +:+
  +#+    +#+       +#+              +#+     +#+    +#+    +#+
 #+#    #+#       #+#              #+#     #+#    #+#    #+#
###    ###       ##########       ###     ###    #########

-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º</title>
    <style>

        :root {--è—è‰²: #00346c;--ç´…è‰²: #b21f1f;--æ¨™1é¡Œè—: #00346c;--æ¨™2é¡Œç´…: #b21f1f;}
        * {margin: 0;padding: 0;box-sizing: border-box;font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; }
        
        body {background: linear-gradient(135deg, var(--è—è‰²) , #000 , var(--ç´…è‰²) );background-attachment: fixed;color: #333;min-height: 100vh;padding: 20px; }
        
        .container {max-width: 1200px;margin: 0 auto;background: rgba(255, 255, 255, 0.95);border-radius: 15px;box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);overflow: hidden; }
        
        header {background: linear-gradient(to right, var(--è—è‰²), var(--ç´…è‰²));color: white;padding: 20px;text-align: center;position: relative; }
        
        .auth-container {position: absolute;top: 20px;right: 20px; }
        
        .auth-button {background: rgba(255, 255, 255, 0.2);border: 1px solid rgba(255, 255, 255, 0.4);color: white;padding: 8px 15px;border-radius: 20px;cursor: pointer;transition: all 0.3s;font-weight: bold; }
        
        .auth-button:hover {background: rgba(255, 255, 255, 0.3); }
        
        .user-info {display: flex;align-items: center;gap: 10px; }
        
        .user-avatar {width: 35px;height: 35px;border-radius: 50%;background: var(--ç´…è‰²);;display: flex;align-items: center;justify-content: center;font-weight: bold; }
        
        h1 {font-size: 2.5rem;margin-bottom: 10px;text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        
        .search-container {padding: 20px;background: #f8f9fa;border-bottom: 1px solid #e0e0e0; }
        
        #search-box {width: 100%;padding: 12px 20px;border: 2px solid #ddd;border-radius: 30px;font-size: 1rem;transition: all 0.3s; }
        
        #search-box:focus {border-color: var(--è—è‰²);box-shadow: 0 0 10px rgba(58, 97, 134, 0.3);outline: none; }
        
        .novel-list {padding: 20px; }
        
        .novel-item {background: white;border-radius: 10px;padding: 20px;margin-bottom: 15px;box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);transition: transform 0.3s, box-shadow 0.3s;border-left: 5px solid var(--è—è‰²);display: flex;flex-direction: column; }
        
        .novel-item:hover {transform: translateY(-3px);box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        
        .novel-item.paid {border-left: 5px solid var(--ç´…è‰²); }
        
        .novel-item h3 {color: #2c3e50;margin-bottom: 10px;cursor: pointer;font-size: 1.4rem;display: flex;align-items: center; }
        
        .novel-item.paid h3 {color: var(--ç´…è‰²); }
        .novel-item.paid h3::after {content: "ğŸ’Š";font-size: 0.7rem;padding: 3px 8px;border-radius: 15px;margin-left: 10px; }
        

        
        .meta-info {display: flex;justify-content: space-between;color: #7f8c8d;font-size: 0.9rem;margin-top: 10px; }
        
        .modal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.7);z-index: 1000;justify-content: center;align-items: center; }
        
        .modal-content {background: white;border-radius: 15px;width: 90%;max-width: 600px;max-height: 80vh;overflow-y: auto;padding: 30px;position: relative;box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3); }
        
        .close-modal {position: absolute;top: 15px;right: 15px;font-size: 1.5rem;cursor: pointer;color: #7f8c8d;transition: color 0.3s; }
        
        .close-modal:hover {color: var(--ç´…è‰²); }
        
        #modal-title {color: #7a7a7a;margin-bottom: 10px;padding-right: 30px; }
        
        #modal-author {color: #7f8c8d;margin-bottom: 20px;font-style: italic; }
        
        #modal-body {line-height: 1.8;color: #7a7a7a; }
        
        .payment-content {text-align: center;padding: 20px; }
        
        .payment-content h2 {color: var(--ç´…è‰²);margin-bottom: 20px; }
        
        .payment-content p {margin-bottom: 25px;line-height: 1.6; }
        
        .payment-button {background: linear-gradient(to right, var(--è—è‰²), var(--ç´…è‰²));color: white;border: none;padding: 12px 30px;border-radius: 30px;font-size: 1rem;cursor: pointer;transition: transform 0.3s, box-shadow 0.3s; }
        
        .payment-button:hover {transform: translateY(-3px);box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        
        footer {text-align: center;padding: 20px;color: white;margin-top: 30px;font-size: 0.9rem; }
        
        .auth-modal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.7);z-index: 1000;justify-content: center;align-items: center; }
        
        .auth-modal-content {background: white;border-radius: 15px;width: 90%;max-width: 400px;padding: 30px;position: relative;box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);text-align: center; }
        
        .auth-form {display: flex;flex-direction: column;gap: 15px;margin-top: 20px; }
        
        .auth-form input {padding: 12px 15px;border: 1px solid #ddd;border-radius: 5px;font-size: 1rem; }
        
        .auth-form button {background: linear-gradient(to right, var(--è—è‰²), var(--ç´…è‰²));color: white;border: none;padding: 12px;border-radius: 5px;font-size: 1rem;cursor: pointer;margin-top: 10px; }
        
        .auth-providers {margin-top: 20px;display: flex;flex-direction: column;gap: 10px; }
        
        .auth-provider-btn {display: flex;align-items: center;justify-content: center;gap: 10px;padding: 10px;border: 1px solid #ddd;border-radius: 5px;background: white;color: var(--è—è‰²);cursor: pointer;transition: background 0.3s; }
        
        .auth-provider-btn:hover {background: var(--ç´…è‰²);color: white; }
        
        .auth-toggle {margin-top: 20px;color: var(--è—è‰²);cursor: pointer;text-decoration: underline; }

.adminBox{display: none; background: #f8f9fa; padding: 15px; border-bottom: 1px solid #e0e0e0;margin-top: 20px; }

.admin-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.admin-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
}

.admin-actions button {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.edit-btn {
    background: #3498db;
    color: white;
}

.delete-btn {
    background: #e74c3c;
    color: white;
}

.toggle-vip-btn {
    background: #f39c12;
    color: white;
}

.is_vip {
    background: var(--è—è‰²);
    color: white;
}
.no_vip {
    background: var(--ç´…è‰²);
    color: white;
}



.toggle-admin-btn {
    background: #9b59b6;
    color: white;
}


.add-novel-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-group label {
    font-weight: bold;
    color: var(--è—è‰²);
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

.form-group textarea {
    resize: vertical;
    min-height: 150px;
}

.settings-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.settings-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.settings-form .form-group label {
    font-weight: bold;
    color: var(--è—è‰²);
}

.settings-form .form-group input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

        @media (max-width: 768px) {.meta-info {flex-direction: column;}
            .meta-info span {margin-bottom: 5px;}
            h1 {font-size: 2rem;}
            .auth-container {position: static;margin-top: 15px;} }












    </style>
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js">//Firestoreåº«çš„å¼•ç”¨</script>
</head>
























































<!--
      :::::::::       ::::::::       :::::::::    :::   :::
     :+:    :+:     :+:    :+:      :+:    :+:   :+:   :+:
    +:+    +:+     +:+    +:+      +:+    +:+    +:+ +:+
   +#++:++#+      +#+    +:+      +#+    +:+     +#++:
  +#+    +#+     +#+    +#+      +#+    +#+      +#+
 #+#    #+#     #+#    #+#      #+#    #+#      #+#
#########       ########       #########       ###
-->
<body>
    <div class="container">
        <header>
            <h1>æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º</h1>
            <p>æ¢ç´¢ç„¡é™æƒ³è±¡çš„ä¸–ç•Œ</p>
            <div class="auth-container">
                <button id="auth-button" class="auth-button">ç™»å…¥</button>
                <div id="user-info" class="user-info" style="display: none;">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-name">ç”¨æˆ¶</span>
                    <button id="sign-out-button" class="auth-button">é€€å‡º</button>
                </div>
            </div>

<!-- ä¿®æ”¹ç®¡ç†å‘˜é¢æ¿éƒ¨åˆ†ï¼Œåœ¨ç°æœ‰æŒ‰é’®åæ·»åŠ æ–°å¢æ–‡ç« æŒ‰é’® -->
<div id="admin-panel" class="adminBox">
    <h3 style="margin-bottom: 15px;">ç®¡ç†å“¡é¢æ¿</h3>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="add-novel-btn" class="auth-button">æ–°å¢æ–‡ç« </button>
        <button id="manage-novels-btn" class="auth-button">ç®¡ç†æ–‡ç« </button>
        <button id="manage-users-btn" class="auth-button">ç®¡ç†ç”¨æˆ¶</button>
        <button id="site-settings-btn" class="auth-button">ç¶²ç«™è¨­å®š</button>
    </div>
</div>
        </header>
        
        <div class="search-container">
            <input type="text" id="search-box" placeholder="æœç´¢å°èªªæ¨™é¡Œæˆ–ä½œè€…...">
        </div>
        
        <div class="novel-list">
            <div id="novel-list-container">
                <!-- å°èªªåˆ—è¡¨å°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- å…§å®¹å½ˆçª— -->
    <div id="content-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-content-modal">&times;</span>
            <h2 id="modal-title"></h2>
            <p id="modal-author"></p>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- ä»˜è²»æç¤ºå½ˆçª— -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-payment-modal">&times;</span>
            <div class="payment-content">
                <h2>è¨‚é–±ä»¥é–±è®€å®Œæ•´å…§å®¹</h2>
                <p>æ­¤ç« ç¯€ç‚ºä»˜è²»å…§å®¹ï¼Œè«‹è¨‚é–±å¾Œç¹¼çºŒé–±è®€ã€‚è¨‚é–±å¾Œæ‚¨å¯ä»¥äº«å—ç„¡å»£å‘Šçš„å®Œæ•´é–±è®€é«”é©—ï¼Œä¸¦æ”¯æŒä½œè€…æŒçºŒå‰µä½œã€‚</p>
                <p id="vip-status-message" style="display: none;">
                æ‚¨å·²ç¶“æ˜¯VIPç”¨æˆ¶ï¼Œå¦‚æœç„¡æ³•æŸ¥çœ‹å…§å®¹ï¼Œè«‹å˜—è©¦åˆ·æ–°é é¢æˆ–é‡æ–°ç™»éŒ„ã€‚
            </p>
            <button class="payment-button">å‡ç´šVIP</button>
            </div>
        </div>
    </div>
    
    <!-- ç™»éŒ„/è¨»å†Šå½ˆçª— -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal" id="close-auth-modal">&times;</span>
            <div class="auth-providers">
                <button class="auth-provider-btn google" id="google-signin">
                    <span>ä½¿ç”¨ Google ç™»éŒ„</span>
                </button>
            </div>
        </div>
    </div>

    
<!-- ç®¡ç†å“¡æ–‡ç« ç®¡ç†æ¨¡æ…‹çª—å£ -->
<div id="admin-novels-modal" class="modal">
    
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal" id="close-admin-novels-modal">&times;</span>
        <h2>æ–‡ç« ç®¡ç†</h2>
        <div id="admin-novels-list">
            <!-- æ–‡ç« åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- ç½‘ç«™è®¾ç½®æ¨¡æ€çª—å£ -->
<div id="site-settings-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" id="close-site-settings-modal">&times;</span>
        <h2>ç¶²ç«™è¨­å®š</h2>
        <div class="settings-form">
            <div class="form-group">
                <label for="site-title">ç¶²ç«™æ¨™é¡Œ:</label>
                <input type="text" id="site-title" placeholder="è¼¸å…¥ç¶²ç«™æ¨™é¡Œ">
            </div>
            <div class="form-group">
                <label for="site-subtitle">ç¶²ç«™å‰¯æ¨™é¡Œ:</label>
                <input type="text" id="site-subtitle" placeholder="è¼¸å…¥ç¶²ç«™å‰¯æ¨™é¡Œ">
            </div>
            <div class="form-group">
                <label for="user-display-name">æ‚¨çš„é¡¯ç¤ºåç¨±:</label>
                <input type="text" id="user-display-name" placeholder="è¼¸å…¥é¡¯ç¤ºåç¨±">
                <small style="color: #666; font-size: 0.8rem;">æ­¤åç¨±å°‡åœ¨æ‚¨çš„æ–‡ç« ä¸­é¡¯ç¤ºç‚ºä½œè€…</small>
            </div>
            <button id="save-settings-btn" class="payment-button">ä¿å­˜è¨­å®š</button>
        </div>
    </div>
</div>


<!-- æ–°å¢æ–‡ç« æ¨¡æ€çª—å£ -->
<div id="add-novel-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-modal" id="close-add-novel-modal">&times;</span>
        <h2>æ–°å¢æ–‡ç« </h2>
        <div class="add-novel-form">
            <div class="form-group">
                <label for="novel-title">æ¨™é¡Œ:</label>
                <input type="text" id="novel-title" placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œ">
            </div>
            <!-- ä¿®æ”¹ä½œè€…è¾“å…¥æ¡†ï¼Œæ·»åŠ readonlyå±æ€§ -->
<div class="form-group">
    <label for="novel-author">ä½œè€…:</label>
    <input type="text" id="novel-author" placeholder="è¼¸å…¥ä½œè€…åç¨±" readonly>
    <small style="color: #666; font-size: 0.8rem;">æ­¤å­—æ®µå·²è‡ªåŠ¨å¡«å……ä¸ºæ‚¨çš„ç”¨æˆ·å</small>
</div>
            <div class="form-group">
                <label for="novel-publish-date">ç™¼å¸ƒæ—¥æœŸ:</label>
                <input type="date" id="novel-publish-date">
            </div>
            <div class="form-group">
                <label for="novel-type">é¡å‹:</label>
                <select id="novel-type">
                    <option value="free">å…è²»</option>
                    <option value="paid">ä»˜è²»</option>
                </select>
            </div>
            <div class="form-group">
                <label for="novel-content">å…§å®¹:</label>
                <textarea id="novel-content" rows="10" placeholder="è¼¸å…¥æ–‡ç« å…§å®¹"></textarea>
            </div>
            <button id="submit-novel-btn" class="payment-button">æäº¤</button>
        </div>
    </div>
</div>


<!-- ç®¡ç†å“¡ç”¨æˆ¶ç®¡ç†æ¨¡æ…‹çª—å£ -->
<div id="admin-users-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal" id="close-admin-users-modal">&times;</span>
        <h2>ç”¨æˆ¶ç®¡ç†</h2>
        <div id="admin-users-list">
            <!-- ç”¨æˆ¶åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
</div>

    <footer>
        <p>Â© 2024 æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º - æ‰€æœ‰æ¬Šåˆ©ä¿ç•™</p>
    </footer>
</body>



















































    <script type="module">
        // ç¯„ä¾‹å°èªªæ•¸æ“š
        const novels = [
            {id: 1,
                title: "ç¬¬ä¸€ç« ï¼šæ˜Ÿè¾°çš„å‘¼å–š",
                author: "å¹»å¤¢",
                publishDate: "2024-05-20",
                type: "free",
                content: "åœ¨é™é çš„æ˜Ÿç³»é‚Šç·£ï¼Œä¸€é¡†è¢«éºå¿˜çš„æ˜Ÿçƒä¸Šï¼Œå¤è€çš„é è¨€æ‚„ç„¶ç”¦é†’ã€‚å°‘å¹´è‰¾å€«ä¸¦ä¸çŸ¥é“ï¼Œä»–å¹³å‡¡çš„ç”Ÿæ´»å³å°‡å› ç‚ºä¸€å¡Šç¥ç§˜çš„ç™¼å…‰çŸ³é ­è€Œå¾¹åº•æ”¹è®Šã€‚é‚£çŸ³é ­ä¸åƒ…è˜Šå«è‘—å®‡å®™çš„ç§˜å¯†ï¼Œæ›´æŒ‡å¼•è‘—ä»–èµ°å‘ä¸€æ¢å……æ»¿æŒ‘æˆ°èˆ‡å¥‡é‡çš„é“è·¯..."
            },
            {id: 2,
                title: "ç¬¬äºŒç« ï¼šè¿·éœ§æ£®æ—çš„è©¦ç…‰",
                author: "å¹»å¤¢",
                publishDate: "2024-05-27",
                type: "free",
                content: "ç‚ºäº†å°‹æ‰¾çŸ³é ­çš„çœŸç›¸ï¼Œè‰¾å€«è¸å…¥äº†å‚³èªªä¸­çš„è¿·éœ§æ£®æ—ã€‚é€™è£¡çš„æ¯ä¸€æ£µæ¨¹æœ¨éƒ½æ“æœ‰è‡ªå·±çš„æ„è­˜ï¼Œæ¯ä¸€é™£é¢¨éƒ½å¯èƒ½å¸¶ä¾†è‡´å‘½çš„å¹»è¦ºã€‚ä»–å¿…é ˆå­¸æœƒå‚¾è½è‡ªç„¶ï¼Œåˆ†è¾¨çœŸå¯¦èˆ‡è™›å‡ï¼Œæ‰èƒ½æ‰¾åˆ°æ£®æ—æ·±è™•çš„å®ˆè­·è€…ã€‚"
            },
            {id: 3,
                title: "ç¬¬ä¸‰ç« ï¼šå¤©ç©ºä¹‹åŸçš„ç§˜å¯†",
                author: "å¹»å¤¢",
                publishDate: "2024-06-03",
                type: "paid",
                content: "æ­¤ç‚ºä»˜è²»å…§å®¹ã€‚"
            },
            {id: 4,
                title: "åºç« ï¼šç´…æœˆä¹‹å¤œ",
                author: "å¤œè¡Œè€…",
                publishDate: "2024-04-15",
                type: "free",
                content: "ç•¶è¡€ç´…è‰²çš„æœˆäº®é«˜æ›å¤œç©ºï¼Œå¤è€çš„å¥‘ç´„å†æ¬¡ç”Ÿæ•ˆã€‚åŸå¸‚é™°å½±ä¸­çš„å¸è¡€é¬¼èˆ‡ç‹¼äººä¹‹é–“çš„ä¼‘æˆ°å”è­°å³å°‡åˆ°æœŸï¼Œä¸€å ´ç„¡å¯é¿å…çš„æš—å¤œä¹‹æˆ°ï¼Œæ­£éš¨è‘—ä¸€åç„¡æ„é–“é—–å…¥ä»–å€‘ä¸–ç•Œçš„æ™®é€šåµæ¢è€Œæ‹‰é–‹åºå¹•ã€‚"
            },
            {id: 5,
                title: "ç¬¬å››ç« ï¼šæ™‚é–“çš„è£‚ç¸«",
                author: "å¹»å¤¢",
                publishDate: "2024-06-10",
                type: "paid",
                content: "æ­¤ç‚ºä»˜è²»å…§å®¹ã€‚"
            },
            {id: 6,
                title: "ç¬¬ä¸€ç« ï¼šä»£ç¢¼çš„ä½èª",
                author: "å¥‡é»",
                publishDate: "2024-06-08",
                type: "free",
                content: "2077å¹´ï¼Œæ–°äº¬å¸‚ã€‚ä¸€å€‹å›é€†çš„é§­å®¢åœ¨å…¥ä¾µå·¨å‹ä¼æ¥­ã€æ ¸å¿ƒã€çš„æ•¸æ“šåº«æ™‚ï¼Œæ„å¤–ç™¼ç¾äº†ä¸€æ®µç„¡æ³•è§£é‡‹çš„ä»£ç¢¼ã€‚é€™æ®µä»£ç¢¼å½·å½¿æ“æœ‰ç”Ÿå‘½ï¼Œå®ƒé–‹å§‹èˆ‡é§­å®¢å°è©±ï¼Œæ­éœ²äº†ä¸€å€‹è¶³ä»¥é¡›è¦†æ•´å€‹ä¸–ç•Œçš„é©šå¤©é™°è¬€ã€‚"
            }
        ];






















/*
      :::::::::           :::        ::::::::       ::::::::::
     :+:    :+:        :+: :+:     :+:    :+:      :+:
    +:+    +:+       +:+   +:+    +:+             +:+
   +#++:++#+       +#++:++#++:   +#++:++#++      +#++:++#
  +#+    +#+      +#+     +#+          +#+      +#+
 #+#    #+#      #+#     #+#   #+#    #+#      #+#
#########       ###     ###    ########       ##########
*/

        // Firebaseé…ç½® - è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›é…ç½®
        const firebaseConfig = {apiKey: "AIzaSyDXPqC7dJ5AeCbWnWNaq95TS_5kW8FlQLU",
            authDomain: "txtbook0907.firebaseapp.com",
            projectId: "txtbook0907",
            storageBucket: "txtbook0907.firebasestorage.app",
            messagingSenderId: "210063365022",
            appId: "1:210063365022:web:a22c4fa22bf112af86fc8f",
            measurementId: "G-N4DVV37B5M"
        };
        
        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // æ·»åŠ æ•¸æ“šåº«å¼•ç”¨
        const db = firebase.firestore();
        
        // DOMå…ƒç´ 
        const listContainer = document.getElementById('novel-list-container');
        const searchBox = document.getElementById('search-box');
        const contentModal = document.getElementById('content-modal');
        const paymentModal = document.getElementById('payment-modal');
        const authModal = document.getElementById('auth-modal');
        const closeContentBtn = document.getElementById('close-content-modal');
        const closePaymentBtn = document.getElementById('close-payment-modal');
        const closeAuthBtn = document.getElementById('close-auth-modal');
        const authButton = document.getElementById('auth-button');
        const signOutButton = document.getElementById('sign-out-button');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const authToggle = document.getElementById('auth-toggle');
        const authModalTitle = document.getElementById('auth-modal-title');
        const googleSignIn = document.getElementById('google-signin');
        
        let isLoginMode = true;


















/*
      ::::::::       ::::::::::       ::::::::::
    :+:    :+:      :+:              :+:
   +:+             +:+              +:+
  +#++:++#++      +#++:++#         +#++:++#
        +#+      +#+              +#+
#+#    #+#      #+#              #+#
########       ##########       ##########

*/

// æ¸²æŸ“å°èªªåˆ—è¡¨ - å¾Firestoreç²å–æ•¸æ“š
async function renderNovelsFromFirestore() {
    try {
        // å¾Firestoreç²å–å°èªªæ•¸æ“šï¼ŒæŒ‰ç™¼å¸ƒæ—¥æœŸæ’åºï¼ˆæœ€èˆŠçš„åœ¨å‰ï¼‰
        const novelsSnapshot = await db.collection("novels").orderBy("publishDate", "asc").get();
        
        listContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

        if (novelsSnapshot.empty) {
            listContainer.innerHTML = '<p class="no-results">æš«ç„¡æ–‡ç« ã€‚</p>';
            return;
        }

        // å°‡Firestoreæ–‡æª”è½‰æ›ç‚ºæ•¸çµ„
        const novelsArray = [];
        novelsSnapshot.forEach(doc => {
            novelsArray.push(doc.data());
        });

        // æ¸²æŸ“å°èªªåˆ—è¡¨
        novelsArray.forEach(novel => {
            const novelItem = document.createElement('div');
            novelItem.className = `novel-item ${novel.type}`;
            novelItem.innerHTML = `
                <h3 data-id="${novel.id}">${novel.title}</h3>
                <div class="meta-info">
                    <span class="author">${novel.author}</span>
                    <span class="date">${novel.publishDate}</span>
                </div>
            `;
            listContainer.appendChild(novelItem);
        });
    } catch (error) {
        console.error("ç²å–å°èªªæ•¸æ“šå¤±æ•—: ", error);
        listContainer.innerHTML = '<p class="no-results">åŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦ã€‚</p>';
    }
}

        // é¡¯ç¤ºå…è²»å…§å®¹å½ˆçª—
        function showContentModal(novel) {document.getElementById('modal-title').textContent = novel.title;document.getElementById('modal-author').textContent = `ä½œè€…ï¼š${novel.author}`;document.getElementById('modal-body').textContent = novel.content;contentModal.style.display = 'flex'; }

        // é¡¯ç¤ºä»˜è²»æç¤ºå½ˆçª—
function showPaymentModal() {
    const user = auth.currentUser;
    const vipMessage = document.getElementById('vip-status-message');
    
    if (user) {
        checkUserVipStatus(user.uid)
            .then(isVip => {
                vipMessage.style.display = isVip ? 'block' : 'none';
                paymentModal.style.display = 'flex';
            })
            .catch(error => {
                console.error("æª¢æŸ¥VIPç‹€æ…‹æ™‚å‡ºéŒ¯: ", error);
                vipMessage.style.display = 'none';
                paymentModal.style.display = 'flex';
            });
    } else {
        vipMessage.style.display = 'none';
        paymentModal.style.display = 'flex';
    }
}

        // é¡¯ç¤ºç™»å…¥å½ˆçª—
        function showAuthModal() {authModal.style.display = 'flex'; }

        // é—œé–‰æ‰€æœ‰å½ˆçª—
        function closeModals() {contentModal.style.display = 'none';paymentModal.style.display = 'none';authModal.style.display = 'none'; }

















/*
      :::::::::           :::    :::::::::::           :::
     :+:    :+:        :+: :+:      :+:             :+: :+:
    +:+    +:+       +:+   +:+     +:+            +:+   +:+
   +#+    +:+      +#++:++#++:    +#+           +#++:++#++:
  +#+    +#+      +#+     +#+    +#+           +#+     +#+
 #+#    #+#      #+#     #+#    #+#           #+#     #+#
#########       ###     ###    ###           ###     ###
*/

        // ä½¿ç”¨Googleç™»å…¥
        function signInWithGoogle() {const provider = new firebase.auth.GoogleAuthProvider();auth.signInWithPopup(provider)
                .then(() => {    closeModals();})
                .catch(error => {    alert("Googleç™»éŒ„å¤±æ•—: " + error.message);}); }


// ä¿å­˜ç”¨æˆ¶ä¿¡æ¯åˆ°Firestore - æ·»åŠ é¦–æ¬¡ç™»éŒ„æ—¥æœŸæª¢æŸ¥
function writeUserData(userId, email, name, photoUrl) {
    // å…ˆæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²å­˜åœ¨
    db.collection("users").doc(userId).get()
        .then(doc => {
            if (doc.exists) {
                // ç”¨æˆ¶å·²å­˜åœ¨ï¼Œåªæ›´æ–°åŸºæœ¬ä¿¡æ¯
                const updateData = {
                    email: email,
                    displayName: name || "",
                    photoUrl: photoUrl || "",
                    lastLogin: new Date().toISOString()
                };
                
                // ä½¿ç”¨mergeé¸é …ä¿ç•™ç¾æœ‰å­—æ®µ
                return db.collection("users").doc(userId).set(updateData, { merge: true });
            } else {
                // æ–°ç”¨æˆ¶ï¼Œæ·»åŠ é¦–æ¬¡ç™»éŒ„æ—¥æœŸ
                const newUserData = {
                    email: email,
                    displayName: name || "",
                    photoUrl: photoUrl || "",
                    firstLogin: new Date().toISOString(), // æ–°å¢é¦–æ¬¡ç™»éŒ„æ—¥æœŸ
                    lastLogin: new Date().toISOString(),
                    vip:false // é»˜èªéVIPç”¨æˆ¶
                };
                
                return db.collection("users").doc(userId).set(newUserData);
            }
        })
        .then(() => {
            console.log("ç”¨æˆ¶æ•¸æ“šæ›´æ–°æˆåŠŸ");
        })
        .catch((error) => {
            console.error("ç”¨æˆ¶æ•¸æ“šæ›´æ–°å¤±æ•—: ", error);
        });
}
// æª¢æŸ¥ç”¨æˆ¶VIPç‹€æ…‹
function checkUserVipStatus(userId) {
    return db.collection("users").doc(userId).get()
        .then(doc => {
            if (doc.exists) {
                return doc.data().vip === true;
            }
            return false;
        })
        .catch(error => {
            console.error("ç²å–ç”¨æˆ¶VIPç‹€æ…‹å¤±æ•—: ", error);
            return false;
        });
}


// æª¢æŸ¥ç”¨æˆ¶ç®¡ç†å“¡ç‹€æ…‹ - æ·»åŠ æ›´åš´æ ¼çš„æª¢æŸ¥
async function checkUserAdminStatus(userId) {
    try {
        const userDoc = await db.collection("users").doc(userId).get();
        if (userDoc.exists) {
            return userDoc.data().admin === true;
        }
        return false;
    } catch (error) {
        console.error("ç²å–ç”¨æˆ¶ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—: ", error);
        return false;
    }
}







// æ‰“å¼€æ–°å¢æ–‡ç« æ¨¡æ€çª—å£
document.getElementById('add-novel-btn').addEventListener('click', async () => {
    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    document.getElementById('novel-publish-date').valueAsDate = new Date();
    
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¹¶è®¾ç½®ä½œè€…å­—æ®µ
    const user = auth.currentUser;
    if (user) {
        try {
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„displayName
            const userDoc = await db.collection("users").doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                document.getElementById('novel-author').value = userData.displayName || user.email;
            } else {
                document.getElementById('novel-author').value = user.displayName || user.email;
            }
        } catch (error) {
            console.error("ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—: ", error);
            document.getElementById('novel-author').value = user.displayName || user.email;
        }
    } else {
        // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ¸…ç©ºä½œè€…å­—æ®µ
        document.getElementById('novel-author').value = '';
    }
    
    document.getElementById('add-novel-modal').style.display = 'flex';
});

// å…³é—­æ–°å¢æ–‡ç« æ¨¡æ€çª—å£
document.getElementById('close-add-novel-modal').addEventListener('click', () => {
    document.getElementById('add-novel-modal').style.display = 'none';
});

// æäº¤æ–°æ–‡ç« 
document.getElementById('submit-novel-btn').addEventListener('click', async () => {
    const title = document.getElementById('novel-title').value;
    const author = document.getElementById('novel-author').value;
    const publishDate = document.getElementById('novel-publish-date').value;
    const type = document.getElementById('novel-type').value;
    const content = document.getElementById('novel-content').value;
    
    if (!title || !author || !publishDate || !content) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    try {
        // ç”Ÿæˆæ–°IDï¼ˆä½¿ç”¨Firestoreè‡ªåŠ¨ç”Ÿæˆçš„IDï¼‰
        const novelRef = db.collection("novels").doc();
        
        // åˆ›å»ºæ–°æ–‡ç« å¯¹è±¡
        const newNovel = {
            id: novelRef.id, // ä½¿ç”¨Firestoreè‡ªåŠ¨ç”Ÿæˆçš„ID
            title,
            author,
            publishDate,
            type,
            content,
            createdAt: new Date().toISOString()
        };
        
        // ä¿å­˜åˆ°Firestore
        await novelRef.set(newNovel);
        
        alert('æ–‡ç« æ–°å¢æˆåŠŸï¼');
        
        // å…³é—­æ¨¡æ€çª—å£
        document.getElementById('add-novel-modal').style.display = 'none';
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('novel-title').value = '';
        document.getElementById('novel-author').value = '';
        document.getElementById('novel-publish-date').valueAsDate = new Date();
        document.getElementById('novel-type').value = 'free';
        document.getElementById('novel-content').value = '';
        
        // åˆ·æ–°æ–‡ç« åˆ—è¡¨
        await renderNovelsFromFirestore();
        
    } catch (error) {
        console.error("æ–°å¢æ–‡ç« å¤±æ•—: ", error);
        alert("æ–°å¢æ–‡ç« å¤±æ•—ï¼Œè«‹é‡è©¦");
    }
});

// åŠ è¼‰æ–‡ç« ç®¡ç†åˆ—è¡¨ - æ·»åŠ éŒ¯èª¤è™•ç†
async function loadNovelsForAdmin() {
    try {
        const novelsSnapshot = await db.collection("novels").orderBy("createdAt", "desc").get();
        const novelsList = document.getElementById('admin-novels-list');
        novelsList.innerHTML = '';
        
        if (novelsSnapshot.empty) {
            novelsList.innerHTML = '<p>æš«ç„¡æ–‡ç« æ•¸æ“š</p>';
            return;
        }
        
        novelsSnapshot.forEach(doc => {
            const novel = doc.data();
            const novelItem = document.createElement('div');
            novelItem.className = 'admin-item';
            novelItem.innerHTML = `
                <h4>${novel.title || 'ç„¡æ¨™é¡Œ'}</h4>
                <p>ä½œè€…: ${novel.author || 'æœªçŸ¥'}</p>
                <p>é¡å‹: ${novel.type || 'æœªçŸ¥'}</p>
                <p>ç™¼å¸ƒæ—¥æœŸ: ${novel.publishDate || 'æœªçŸ¥'}</p>
                <div class="admin-actions">
                    <button class="edit-btn" data-id="${doc.id}">ç·¨è¼¯</button>
                    <button class="delete-btn" data-id="${doc.id}">åˆªé™¤</button>
                </div>
            `;
            novelsList.appendChild(novelItem);
        });
    } catch (error) {
        console.error("åŠ è¼‰æ–‡ç« åˆ—è¡¨å¤±æ•—: ", error);
        const novelsList = document.getElementById('admin-novels-list');
        novelsList.innerHTML = `
            <p>åŠ è¼‰å¤±æ•—: ${error.message}</p>
            <p>è«‹æª¢æŸ¥æ‚¨æ˜¯å¦æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œæˆ–åˆ·æ–°é é¢é‡è©¦ã€‚</p>
        `;
    }
}




// åŠ è¼‰ç”¨æˆ¶ç®¡ç†åˆ—è¡¨ - æ·»åŠ éŒ¯èª¤è™•ç†
async function loadUsersForAdmin() {
    try {
        const usersSnapshot = await db.collection("users").get();
        const usersList = document.getElementById('admin-users-list');
        usersList.innerHTML = '';
        
        if (usersSnapshot.empty) {
            usersList.innerHTML = '<p>æš«ç„¡ç”¨æˆ¶æ•¸æ“š</p>';
            return;
        }
        
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            const userItem = document.createElement('div');
            userItem.className = 'admin-item';
            
            // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•¸
            const formatDate = (dateString) => {
                if (!dateString) return 'æœªçŸ¥';
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            };
            
            userItem.innerHTML = `
            <hr>
                <h4>${user.displayName || user.email || 'æœªçŸ¥ç”¨æˆ¶'}</h4>
                <p>éƒµç®±: ${user.email || 'æœªçŸ¥'}</p>
                <p>é¦–æ¬¡ç™»éŒ„: ${user.firstLogin ? formatDate(user.firstLogin) : 'æœªçŸ¥'}</p>
                <p>æœ€å¾Œç™»éŒ„: ${user.lastLogin ? formatDate(user.lastLogin) : 'æœªçŸ¥'}</p>
                <p>VIP: ${user.vip ? 'æ˜¯' : 'å¦'} | ç®¡ç†å“¡: ${user.admin ? 'æ˜¯' : 'å¦'}</p>
                <div class="admin-actions">
                    <button class="${user.vip ? 'is_vip' : 'no_vip'}" data-id="${doc.id}" data-vip="${user.vip || false}">
                        ${user.vip ? 'â¬‡ï¸å–æ¶ˆVIP' : 'â¬†ï¸è¨­ç‚ºVIP'}
                    </button>
                </div>
                
            `;
            usersList.appendChild(userItem);
        });
    } catch (error) {
        console.error("åŠ è¼‰ç”¨æˆ¶åˆ—è¡¨å¤±æ•—: ", error);
        const usersList = document.getElementById('admin-users-list');
        usersList.innerHTML = `
            <p>åŠ è¼‰å¤±æ•—: ${error.message}</p>
            <p>è«‹æª¢æŸ¥æ‚¨æ˜¯å¦æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œæˆ–åˆ·æ–°é é¢é‡è©¦ã€‚</p>
        `;
    }
}



// æ‰“å¼€ç½‘ç«™è®¾ç½®æ¨¡æ€çª—å£
document.getElementById('site-settings-btn').addEventListener('click', async () => {
    // è·å–å½“å‰ç½‘ç«™è®¾ç½®
    try {
        const settingsDoc = await db.collection("settings").doc("site").get();
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            document.getElementById('site-title').value = settings.title || "æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º";
            document.getElementById('site-subtitle').value = settings.subtitle || "æ¢ç´¢ç„¡é™æƒ³è±¡çš„ä¸–ç•Œ";
        } else {
            // ä½¿ç”¨é»˜è®¤å€¼
            document.getElementById('site-title').value = "æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º";
            document.getElementById('site-subtitle').value = "æ¢ç´¢ç„¡é™æƒ³è±¡çš„ä¸–ç•Œ";
        }
    } catch (error) {
        console.error("ç²å–ç¶²ç«™è¨­å®šå¤±æ•—: ", error);
        // ä½¿ç”¨é»˜è®¤å€¼
        document.getElementById('site-title').value = "æ˜Ÿè¾°å°èªªé–±è®€å¹³è‡º";
        document.getElementById('site-subtitle').value = "æ¢ç´¢ç„¡é™æƒ³è±¡çš„ä¸–ç•Œ";
    }
    
    // è·å–å½“å‰ç”¨æˆ·æ˜¾ç¤ºåç§°
    const user = auth.currentUser;
    if (user) {
        try {
            const userDoc = await db.collection("users").doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                document.getElementById('user-display-name').value = userData.displayName || user.email || "";
            } else {
                document.getElementById('user-display-name').value = user.displayName || user.email || "";
            }
        } catch (error) {
            console.error("ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—: ", error);
            document.getElementById('user-display-name').value = user.displayName || user.email || "";
        }
    }
    
    document.getElementById('site-settings-modal').style.display = 'flex';
});

// å…³é—­ç½‘ç«™è®¾ç½®æ¨¡æ€çª—å£
document.getElementById('close-site-settings-modal').addEventListener('click', () => {
    document.getElementById('site-settings-modal').style.display = 'none';
});

// ä¿å­˜ç½‘ç«™è®¾ç½®
document.getElementById('save-settings-btn').addEventListener('click', async () => {
    const siteTitle = document.getElementById('site-title').value;
    const siteSubtitle = document.getElementById('site-subtitle').value;
    const userDisplayName = document.getElementById('user-display-name').value;
    
    if (!siteTitle) {
        alert('è«‹å¡«å¯«ç¶²ç«™æ¨™é¡Œ');
        return;
    }
    
    try {
        const user = auth.currentUser;
        
        // ä¿å­˜ç½‘ç«™è®¾ç½®
        await db.collection("settings").doc("site").set({
            title: siteTitle,
            subtitle: siteSubtitle,
            updatedAt: new Date().toISOString()
        }, { merge: true });
        
        // ä¿å­˜ç”¨æˆ·æ˜¾ç¤ºåç§°
        if (user && userDisplayName) {
            await db.collection("users").doc(user.uid).set({
                displayName: userDisplayName
            }, { merge: true });
            
            // æ›´æ–°å½“å‰é¡µé¢æ˜¾ç¤ºçš„ç”¨æˆ·å
            userName.textContent = userDisplayName;
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        document.querySelector('header h1').textContent = siteTitle;
        document.querySelector('header p').textContent = siteSubtitle;
        
        alert('è¨­å®šä¿å­˜æˆåŠŸï¼');
        document.getElementById('site-settings-modal').style.display = 'none';
        
    } catch (error) {
        console.error("ä¿å­˜è¨­å®šå¤±æ•—: ", error);
        alert("ä¿å­˜è¨­å®šå¤±æ•—ï¼Œè«‹é‡è©¦");
    }
});

// åŠ è½½ç½‘ç«™è®¾ç½®
async function loadSiteSettings() {
    try {
        const settingsDoc = await db.collection("settings").doc("site").get();
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            if (settings.title) {
                document.querySelector('header h1').textContent = settings.title;
            }
            if (settings.subtitle) {
                document.querySelector('header p').textContent = settings.subtitle;
            }
        }
    } catch (error) {
        console.error("åŠ è¼‰ç¶²ç«™è¨­å®šå¤±æ•—: ", error);
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶åŠ è½½ç½‘ç«™è®¾ç½®
document.addEventListener('DOMContentLoaded', () => {
    renderNovelsFromFirestore();
    loadSiteSettings(); // åŠ è½½ç½‘ç«™è®¾ç½®
});


/*
      ::::::::::      :::    :::       ::::    :::
     :+:             :+:    :+:       :+:+:   :+:
    +:+             +:+    +:+       :+:+:+  +:+
   :#::+::#        +#+    +:+       +#+ +:+ +#+
  +#+             +#+    +#+       +#+  +#+#+#
 #+#             #+#    #+#       #+#   #+#+#
###              ########        ###    ####
*/


// ä¿®æ”¹è®¤è¯çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ä¸­çš„ç®¡ç†å‘˜æ£€æŸ¥éƒ¨åˆ†
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // ç”¨æˆ¶å·²ç™»å…¥
        authButton.style.display = 'none';
        userInfo.style.display = 'flex';
        
        // è·å–ç”¨æˆ·æ˜¾ç¤ºåç§°
        try {
            const userDoc = await db.collection("users").doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                userName.textContent = userData.displayName || user.email;
            } else {
                userName.textContent = user.displayName || user.email;
            }
        } catch (error) {
            console.error("ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—: ", error);
            userName.textContent = user.displayName || user.email;
        }
        
        userAvatar.textContent = userName.textContent.charAt(0).toUpperCase();
        
        // æ›´æ–°ç”¨æˆ·æ•°æ®
        writeUserData(user.uid, user.email, userName.textContent, user.photoURL);
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        try {
            const isAdmin = await checkUserAdminStatus(user.uid);
            if (isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                
                // é¢„åŠ è½½ç®¡ç†å‘˜æ•°æ®
                setTimeout(() => {
                    loadNovelsForAdmin();
                    loadUsersForAdmin();
                }, 1000);
            } else {
                document.getElementById('admin-panel').style.display = 'none';
            }
        } catch (error) {
            console.error("æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€æ—¶å‡ºé”™: ", error);
            document.getElementById('admin-panel').style.display = 'none';
        }
    } else {
        // ç”¨æˆ¶å·²ç™»å‡º
        authButton.style.display = 'block';
        userInfo.style.display = 'none';
        document.getElementById('admin-panel').style.display = 'none';
    }
});

        // äº‹ä»¶ç›£è½
document.addEventListener('DOMContentLoaded', () => {
    renderNovelsFromFirestore(); // ä½¿ç”¨å¾Firestoreç²å–æ•¸æ“šçš„å‡½æ•¸
});

// ä¿®æ”¹æœç´¢åŠŸèƒ½
searchBox.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    
    // ç²å–æ‰€æœ‰å°èªªé …ç›®
    const novelItems = document.querySelectorAll('.novel-item');
    
    // å¦‚æœæ²’æœ‰æœç´¢è©ï¼Œé¡¯ç¤ºæ‰€æœ‰é …ç›®
    if (!searchTerm) {
        novelItems.forEach(item => {
            item.style.display = 'flex';
        });
        return;
    }
    
    // éæ¿¾é …ç›®
    novelItems.forEach(item => {
        const title = item.querySelector('h3').textContent.toLowerCase();
        const author = item.querySelector('.author').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || author.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
});

// ä¿®æ”¹æ–‡ç« é»æ“Šäº‹ä»¶è™•ç†å‡½æ•¸
listContainer.addEventListener('click', async (e) => {
    if (e.target.tagName === 'H3') {
        const novelTitle = e.target.textContent;
        
        try {
            // å¾Firestoreç²å–é»æ“Šçš„æ–‡ç« 
            const novelsSnapshot = await db.collection("novels")
                .where("title", "==", novelTitle)
                .get();
            
            if (novelsSnapshot.empty) {
                console.error("æœªæ‰¾åˆ°ç›¸é—œæ–‡ç« ");
                return;
            }
            
            // ç²å–ç¬¬ä¸€ç¯‡æ–‡ç« ï¼ˆç†è«–ä¸Šæ¨™é¡Œæ‡‰è©²æ˜¯å”¯ä¸€çš„ï¼‰
            const novelDoc = novelsSnapshot.docs[0];
            const novel = novelDoc.data();
            
            const user = auth.currentUser;
            
            if (novel.type === 'free') {
                showContentModal(novel);
            } else {
                // ä»˜è²»å…§å®¹æª¢æŸ¥ç”¨æˆ¶VIPç‹€æ…‹
                if (user) {
                    try {
                        const isVip = await checkUserVipStatus(user.uid);
                        if (isVip) {
                            showContentModal(novel);
                        } else {
                            showPaymentModal();
                        }
                    } catch (error) {
                        console.error("æª¢æŸ¥VIPç‹€æ…‹æ™‚å‡ºéŒ¯: ", error);
                        showPaymentModal();
                    }
                } else {
                    showPaymentModal();
                }
            }
        } catch (error) {
            console.error("ç²å–æ–‡ç« æ•¸æ“šå¤±æ•—: ", error);
        }
    }
});

        // æŒ‰éˆ•äº‹ä»¶
        authButton.addEventListener('click', showAuthModal);
        signOutButton.addEventListener('click', () => auth.signOut());
        googleSignIn.addEventListener('click', signInWithGoogle);

        // é—œé–‰æŒ‰éˆ•äº‹ä»¶
        closeContentBtn.onclick = closeModals;
        closePaymentBtn.onclick = closeModals;
        closeAuthBtn.onclick = closeModals;

        // é»æ“Šå½ˆçª—å¤–éƒ¨å€åŸŸé—œé–‰
        window.onclick = function(event) {if (event.target == contentModal || event.target == paymentModal || event.target == authModal) {closeModals();} }



// ç®¡ç†å“¡æŒ‰éˆ•äº‹ä»¶ç›£è½
document.getElementById('manage-novels-btn').addEventListener('click', async () => {
    await loadNovelsForAdmin();
    document.getElementById('admin-novels-modal').style.display = 'flex';
});

document.getElementById('manage-users-btn').addEventListener('click', async () => {
    await loadUsersForAdmin();
    document.getElementById('admin-users-modal').style.display = 'flex';
});

// é—œé–‰ç®¡ç†å“¡æ¨¡æ…‹çª—å£
document.getElementById('close-admin-novels-modal').addEventListener('click', () => {
    document.getElementById('admin-novels-modal').style.display = 'none';
});

document.getElementById('close-admin-users-modal').addEventListener('click', () => {
    document.getElementById('admin-users-modal').style.display = 'none';
});

// ç”¨æˆ¶ç®¡ç†æ“ä½œäº‹ä»¶å§”è¨—
document.getElementById('admin-users-list').addEventListener('click', async (e) => {
    if (e.target.classList.contains('toggle-vip-btn')) {
        const userId = e.target.dataset.id;
        const isVip = e.target.dataset.vip === 'true';
        
        try {
            await db.collection("users").doc(userId).update({
                vip: !isVip
            });
            alert(`å·²${!isVip ? 'æˆäºˆ' : 'å–æ¶ˆ'}VIPæ¬Šé™`);
            await loadUsersForAdmin(); // åˆ·æ–°åˆ—è¡¨
        } catch (error) {
            console.error("æ›´æ–°VIPç‹€æ…‹å¤±æ•—: ", error);
            alert("æ“ä½œå¤±æ•—");
        }
    }
    
    if (e.target.classList.contains('toggle-admin-btn')) {
        const userId = e.target.dataset.id;
        const isAdmin = e.target.dataset.admin === 'true';
        
        try {
            await db.collection("users").doc(userId).update({
                admin: !isAdmin
            });
            alert(`å·²${!isAdmin ? 'æˆäºˆ' : 'å–æ¶ˆ'}ç®¡ç†å“¡æ¬Šé™`);
            await loadUsersForAdmin(); // åˆ·æ–°åˆ—è¡¨
        } catch (error) {
            console.error("æ›´æ–°ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—: ", error);
            alert("æ“ä½œå¤±æ•—");
        }
    }
});


// æ–‡ç« ç®¡ç†æ“ä½œäº‹ä»¶å§”æ‰˜
document.getElementById('admin-novels-list').addEventListener('click', async (e) => {
    if (e.target.classList.contains('delete-btn')) {
        const novelId = e.target.dataset.id;
        
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
            try {
                await db.collection("novels").doc(novelId).delete();
                alert('æ–‡ç« åˆªé™¤æˆåŠŸ');
                await loadNovelsForAdmin(); // åˆ·æ–°åˆ—è¡¨
            } catch (error) {
                console.error("åˆªé™¤æ–‡ç« å¤±æ•—: ", error);
                alert("åˆªé™¤æ–‡ç« å¤±æ•—");
            }
        }
    }
    
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç¼–è¾‘åŠŸèƒ½çš„å¤„ç†
    if (e.target.classList.contains('edit-btn')) {
        // ç¼–è¾‘åŠŸèƒ½çš„å®ç°
        alert('ç·¨è¼¯åŠŸèƒ½å°šæœªå¯¦ç¾');
    }
});




</script>
</html>